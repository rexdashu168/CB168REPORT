<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rex大叔投資戰情室 v5.1 (完整版)</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 全局字體設定 */
        body { background-color: #f8fafc; font-family: 'Noto Sans TC', sans-serif; color: #1e293b; }
        
        /* 動畫與特效 */
        .section-view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 導航卡片互動 */
        .nav-card { transition: all 0.2s ease; border: 2px solid #e2e8f0; }
        .nav-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #94a3b8; }

        /* 標籤樣式 */
        .tag-pill { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; margin-right: 4px; margin-bottom: 4px; }

        /* 滾動條優化 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* 星星防爆框 */
        .star-container { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="mobileOverlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <aside id="sidebar" class="w-64 bg-slate-900 text-white flex-col hidden md:flex shadow-xl z-50 transition-all duration-300 fixed inset-y-0 left-0 md:relative">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center text-slate-900 font-bold text-xl shadow-lg">R</div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-wide">Rex大叔</h1>
                    <p class="text-xs text-gray-400 mt-1">168 智能戰情室</p>
                </div>
            </div>
            <button onclick="toggleMobileMenu()" class="md:hidden text-gray-400 hover:text-white">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
        </div>

        <nav class="flex-1 py-4 space-y-1 overflow-y-auto">
            <button onclick="goHome()" class="w-full flex items-center px-6 py-4 hover:bg-slate-800 transition text-left border-l-4 border-transparent hover:border-yellow-500 group">
                <i class="fa-solid fa-house text-lg w-8 text-center text-gray-400 group-hover:text-white"></i>
                <span class="font-bold text-lg">戰情首頁</span>
            </button>
            <div class="px-6 py-2 text-xs font-bold text-gray-500 uppercase mt-4">資料庫</div>
            <button onclick="showSection('industry')" class="w-full flex items-center px-6 py-3 hover:bg-slate-800 transition text-left group">
                <i class="fa-solid fa-city text-lg w-8 text-center text-blue-400"></i>
                <span class="text-gray-300 font-medium group-hover:text-white">產業百科</span>
            </button>
            <button onclick="showSection('reports')" class="w-full flex items-center px-6 py-3 hover:bg-slate-800 transition text-left group">
                <i class="fa-solid fa-file-contract text-lg w-8 text-center text-yellow-400"></i>
                <span class="text-gray-300 font-medium group-hover:text-white">研究報告</span>
            </button>
            <button onclick="showSection('news')" class="w-full flex items-center px-6 py-3 hover:bg-slate-800 transition text-left group">
                <i class="fa-solid fa-newspaper text-lg w-8 text-center text-red-400"></i>
                <span class="text-gray-300 font-medium group-hover:text-white">外資快訊</span>
            </button>
        </nav>
        
        <div class="p-4 bg-slate-950 text-xs text-center text-gray-500">
            資料庫狀態: <span id="dbStatus" class="text-yellow-500 font-bold">連線中...</span>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-50">
        
        <header class="h-16 bg-white shadow-sm flex items-center px-4 md:px-8 z-20 border-b border-gray-200 justify-between">
            <div class="flex items-center gap-4">
                <button onclick="toggleMobileMenu()" class="md:hidden text-slate-600 hover:text-slate-900 p-2 rounded-lg hover:bg-slate-100">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3" id="pageTitle">
                    <i class="fa-solid fa-chart-pie text-yellow-600"></i> 戰情總覽
                </h2>
            </div>

            <div class="text-sm font-bold text-slate-600 bg-slate-100 px-4 py-2 rounded-full border border-slate-200 whitespace-nowrap">
                <i class="fa-regular fa-calendar-check mr-2 text-slate-500"></i><span id="currentDate"></span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-10 custom-scroll" id="mainContainer">

            <div id="view-home" class="section-view active">
                <div class="mb-8">
                    <h3 class="text-3xl font-bold text-slate-900 mb-2">早安，Rex 大叔</h3>
                    <p class="text-slate-600 font-medium text-lg">請選擇您要分析的資料模組：</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div onclick="showSection('industry')" class="nav-card bg-white p-6 md:p-8 rounded-2xl cursor-pointer group relative overflow-hidden">
                        <div class="relative z-10 text-center">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-blue-100 text-blue-700 rounded-2xl flex items-center justify-center text-3xl md:text-4xl mb-6 mx-auto shadow-inner">
                                <i class="fa-solid fa-city"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2">產業百科</h3>
                            <p class="text-slate-600 font-medium text-sm md:text-base">查詢公司產品、細產業分類與市場地位</p>
                            <div class="mt-6 text-blue-700 font-bold text-sm bg-blue-50 px-3 py-1 rounded-full inline-block" id="countInd">載入中...</div>
                        </div>
                    </div>

                    <div onclick="showSection('reports')" class="nav-card bg-white p-6 md:p-8 rounded-2xl cursor-pointer group relative overflow-hidden">
                        <div class="relative z-10 text-center">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-yellow-100 text-yellow-700 rounded-2xl flex items-center justify-center text-3xl md:text-4xl mb-6 mx-auto shadow-inner">
                                <i class="fa-solid fa-file-invoice-dollar"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2">研究報告</h3>
                            <p class="text-slate-600 font-medium text-sm md:text-base">瀏覽個股深度分析、營運重點與評等</p>
                            <div class="mt-6 text-yellow-700 font-bold text-sm bg-yellow-50 px-3 py-1 rounded-full inline-block" id="countRep">載入中...</div>
                        </div>
                    </div>

                    <div onclick="showSection('news')" class="nav-card bg-white p-6 md:p-8 rounded-2xl cursor-pointer group relative overflow-hidden">
                        <div class="relative z-10 text-center">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-red-100 text-red-600 rounded-2xl flex items-center justify-center text-3xl md:text-4xl mb-6 mx-auto shadow-inner">
                                <i class="fa-solid fa-bolt"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2">外資快訊</h3>
                            <p class="text-slate-600 font-medium text-sm md:text-base">掌握最新市場傳聞、外電與即時動態</p>
                            <div class="mt-6 text-red-600 font-bold text-sm bg-red-50 px-3 py-1 rounded-full inline-block" id="countNews">載入中...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-industry" class="section-view">
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 mb-6 sticky top-0 z-10">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="search" id="searchIndustry" placeholder="輸入股號、公司名或產品關鍵字..." class="flex-1 p-3 border-2 border-gray-200 rounded-lg text-lg focus:border-blue-500 outline-none text-slate-800 font-medium placeholder-gray-400">
                        <select id="filterIndustryMain" class="p-3 border-2 border-gray-200 rounded-lg bg-white text-lg font-bold text-slate-700 min-w-[200px] cursor-pointer"><option value="">所有主產業</option></select>
                    </div>
                </div>
                <div id="industryList" class="grid grid-cols-1 gap-4"></div>
                <div id="industryPagination" class="flex justify-center mt-8 gap-2"></div>
            </div>

            <div id="view-reports" class="section-view">
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 mb-6 sticky top-0 z-10">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="search" id="searchReport" placeholder="搜尋報告 (如: 台積電, 買進)..." class="col-span-1 md:col-span-2 p-3 border-2 border-gray-200 rounded-lg text-lg focus:border-yellow-500 outline-none text-slate-800 font-medium placeholder-gray-400">
                        <select id="filterReportInd" class="p-3 border-2 border-gray-200 rounded-lg bg-white font-bold text-slate-700 cursor-pointer"><option value="">所有產業</option></select>
                        <select id="filterReportRating" class="p-3 border-2 border-gray-200 rounded-lg bg-white font-bold text-slate-700 cursor-pointer"><option value="">所有評等</option></select>
                    </div>
                </div>
                <div id="reportsList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="reportsPagination" class="flex justify-center mt-8 gap-2"></div>
            </div>

            <div id="view-news" class="section-view">
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200 mb-6 sticky top-0 z-10">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-4 top-4 text-gray-400"></i>
                        <input type="search" id="searchNews" placeholder="搜尋新聞標題、內容..." class="w-full pl-12 p-3 border-2 border-gray-200 rounded-lg text-lg focus:border-red-500 outline-none text-slate-800 font-medium placeholder-gray-400">
                    </div>
                </div>
                <div id="newsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <div id="newsPagination" class="flex justify-center mt-8 gap-2"></div>
            </div>

        </div>
    </main>

    <div id="detailModal" class="fixed inset-0 z-50 hidden" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl border-t-8 border-slate-800 overflow-hidden">
                    
                    <div class="bg-slate-50 px-6 md:px-8 py-6 border-b border-slate-200 flex justify-between items-start">
                        <div>
                            <span class="text-sm font-bold tracking-wider uppercase mb-2 block px-3 py-1 rounded w-fit" id="mCategory">類別</span>
                            <h3 class="text-2xl md:text-3xl font-bold text-slate-900 mb-3 leading-tight" id="mTitle">標題</h3>
                            <div class="flex flex-wrap items-center gap-4 text-slate-600 font-medium">
                                <span id="mSubtitle1" class="bg-white border border-slate-300 px-3 py-1 rounded-md shadow-sm">--</span>
                                <span id="mSubtitle2" class="text-slate-500">--</span>
                            </div>
                        </div>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-700 hover:bg-slate-200 p-2 rounded-full transition">
                            <i class="fa-solid fa-xmark text-3xl"></i>
                        </button>
                    </div>

                    <div class="px-6 md:px-8 py-8 max-h-[65vh] overflow-y-auto custom-scroll bg-white">
                        <div id="mContent" class="space-y-8"></div>
                    </div>

                    <div class="bg-slate-100 px-8 py-4 border-t border-slate-200 text-right">
                        <button onclick="closeModal()" class="px-8 py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition font-bold shadow-md">關閉視窗</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 檔案設定 (對應新檔案) ===
        const FILES = { 
            ind: 'industry.xlsx', 
            rep: 'reports.xlsx', 
            news: 'news.xlsx' 
        };
        const PAGE_SIZE = 12;

        let DB = { industry: [], reports: [], news: [], indMap: {} };
        let APP = { currentView: 'home', page: 1 };

        // === 初始化 ===
        document.addEventListener('DOMContentLoaded', () => {
            const d = new Date();
            document.getElementById('currentDate').textContent = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
            loadData();

            // 搜尋監聽
            setupSearch('searchIndustry', () => { APP.page=1; renderIndustry(); });
            setupSearch('searchReport', () => { APP.page=1; renderReports(); });
            setupSearch('searchNews', () => { APP.page=1; renderNews(); });
            
            // 下拉監聽
            document.getElementById('filterIndustryMain').addEventListener('change', () => { APP.page=1; renderIndustry(); });
            document.getElementById('filterReportInd').addEventListener('change', () => { APP.page=1; renderReports(); });
            document.getElementById('filterReportRating').addEventListener('change', () => { APP.page=1; renderReports(); });
        });

        function setupSearch(id, callback) {
            let timeout;
            document.getElementById(id).addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(callback, 300);
            });
        }

        // === 資料讀取核心 (針對新檔案優化) ===
        async function loadData() {
            const status = document.getElementById('dbStatus');
            try {
                // 1. 讀取 Industry
                const bufInd = await fetch(FILES.ind).then(r => r.arrayBuffer());
                const wbInd = XLSX.read(bufInd);
                DB.industry = XLSX.utils.sheet_to_json(wbInd.Sheets[wbInd.SheetNames[0]]);
                
                // 建立對照表
                DB.industry.forEach(row => {
                    if(row['代號']) DB.indMap[row['代號'].toString().trim()] = row;
                });

                // 2. 讀取 Reports
                const bufRep = await fetch(FILES.rep).then(r => r.arrayBuffer());
                const wbRep = XLSX.read(bufRep);
                DB.reports = XLSX.utils.sheet_to_json(wbRep.Sheets[wbRep.SheetNames[0]]).map(r => {
                    let stockId = r['股號'] ? r['股號'].toString().trim() : '';
                    // 自動修復產業
                    if(!r['產業'] && stockId && DB.indMap[stockId]) {
                        r['產業'] = DB.indMap[stockId]['產業'];
                    }
                    return r;
                });

                // 3. 讀取 News (自動生成標題)
                const bufNews = await fetch(FILES.news).then(r => r.arrayBuffer());
                const wbNews = XLSX.read(bufNews);
                DB.news = XLSX.utils.sheet_to_json(wbNews.Sheets[wbNews.SheetNames[0]]).map(n => {
                    if(!n['標題'] && !n['Title']) {
                        const broker = n['券商來源'] || '外資';
                        const company = n['公司'] || '';
                        const focus = n['報導重點分類'] || '市場快訊';
                        n['標題'] = `【${broker}】${company} - ${focus}`;
                    }
                    return n;
                });

                // 狀態更新
                status.textContent = "資料庫連線正常";
                status.classList.replace('text-yellow-500', 'text-green-400');
                
                document.getElementById('countInd').textContent = `共 ${DB.industry.length} 筆`;
                document.getElementById('countRep').textContent = `共 ${DB.reports.length} 篇`;
                document.getElementById('countNews').textContent = `共 ${DB.news.length} 則`;

                initDropdowns();

            } catch (e) {
                console.error(e);
                status.textContent = "讀取失敗";
                status.classList.replace('text-yellow-500', 'text-red-500');
            }
        }

        function initDropdowns() {
            const inds = new Set(DB.industry.map(x => x['產業']).filter(Boolean));
            fillSelect('filterIndustryMain', inds);
            fillSelect('filterReportInd', inds);

            const ratings = new Set(DB.reports.map(x => x['投資評等']).filter(Boolean));
            fillSelect('filterReportRating', ratings);
        }

        function fillSelect(id, set) {
            const el = document.getElementById(id);
            Array.from(set).sort().forEach(v => {
                const opt = document.createElement('option');
                opt.value = v; opt.textContent = v; el.appendChild(opt);
            });
        }

        // === 介面切換 ===
        function goHome() { showSection('home'); }
        function showSection(id) {
            APP.currentView = id;
            APP.page = 1;
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${id}`).classList.add('active');
            
            const titles = {
                'home': '<i class="fa-solid fa-chart-pie text-yellow-600"></i> 戰情總覽',
                'industry': '<i class="fa-solid fa-city text-blue-600"></i> 產業百科',
                'reports': '<i class="fa-solid fa-file-contract text-yellow-600"></i> 研究報告',
                'news': '<i class="fa-solid fa-newspaper text-red-600"></i> 外資快訊'
            };
            document.getElementById('pageTitle').innerHTML = titles[id];

            if(id === 'industry') renderIndustry();
            if(id === 'reports') renderReports();
            if(id === 'news') renderNews();
            
            document.getElementById('mainContainer').scrollTo(0,0);
            
            // 手機版自動關閉選單
            if(window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobileOverlay');
                if(sidebar) sidebar.classList.add('hidden');
                if(overlay) overlay.classList.add('hidden');
            }
        }

        // === 列表渲染器 ===
        function renderList(containerId, data, renderFunc, paginationId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if(data.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-gray-400 text-xl font-bold">查無資料</div>`;
                document.getElementById(paginationId).innerHTML = '';
                return;
            }

            const start = (APP.page - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            data.slice(start, end).forEach(item => {
                container.insertAdjacentHTML('beforeend', renderFunc(item));
            });

            renderPagination(paginationId, data.length);
        }

        // 1. 產業百科
        function renderIndustry() {
            const key = document.getElementById('searchIndustry').value.toLowerCase();
            const cat = document.getElementById('filterIndustryMain').value;
            
            const filtered = DB.industry.filter(item => {
                const str = Object.values(item).join(' ').toLowerCase();
                return str.includes(key) && (cat === '' || item['產業'] === cat);
            });

            renderList('industryList', filtered, (item) => `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-blue-400 hover:shadow-md transition cursor-pointer" onclick="openModal('industry', this.dataset.json)" data-json='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="bg-slate-800 text-white px-3 py-1 rounded text-lg font-bold font-mono">${item['代號']}</span>
                            <div>
                                <h3 class="text-xl font-bold text-slate-900">${item['名稱']}</h3>
                                <span class="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">${item['產業']}</span>
                            </div>
                        </div>
                        <div class="hidden md:block text-right">
                            <div class="text-sm text-gray-500 font-bold">細產業</div>
                            <div class="text-slate-700 font-medium text-lg">${item['細產業'] || '--'}</div>
                        </div>
                    </div>
                    <div class="mt-4 text-slate-600 line-clamp-2 border-t border-gray-100 pt-3">
                        <span class="font-bold text-slate-800">產業地位：</span>${item['產業地位'] || '無資料'}
                    </div>
                </div>
            `, 'industryPagination');
        }

        // 2. 研究報告
        function renderReports() {
            const key = document.getElementById('searchReport').value.toLowerCase();
            const ind = document.getElementById('filterReportInd').value;
            const rate = document.getElementById('filterReportRating').value;

            const filtered = DB.reports.filter(item => {
                // 優化：搜尋標籤和Rex觀察
                const str = (item['公司'] + item['股號'] + item['精簡重點摘要'] + (item['標籤']||'') + (item['Rex觀察']||'')).toLowerCase();
                return str.includes(key) && (ind === '' || item['產業'] === ind) && (rate === '' || item['投資評等'] === rate);
            });

            renderList('reportsList', filtered, (item) => {
                let rateColor = 'bg-gray-100 text-gray-600';
                if(item['投資評等']?.includes('買') || item['投資評等']?.includes('Buy') || item['投資評等']?.includes('Overweight')) {
                    rateColor = 'bg-red-100 text-red-700 border border-red-200';
                }
                
                let stars = item['重要性'] || '⭐⭐';
                if(stars.length > 5) stars = '⭐⭐⭐⭐⭐'; 

                return `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col h-full" onclick="openModal('report', this.dataset.json)" data-json='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded">${item['產業'] || '個股'}</span>
                        <span class="text-sm font-bold text-slate-400 font-mono">${item['報告日期']}</span>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-900 mb-2 flex items-center gap-2">
                        ${item['公司']} <span class="text-sm font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded font-mono">${item['股號']}</span>
                    </h3>
                    
                    <div class="flex flex-wrap items-center gap-2 mb-4 text-sm">
                        <span class="text-yellow-500 text-lg star-container">${stars}</span>
                        <span class="text-gray-300">|</span>
                        <span class="font-bold text-slate-600 truncate max-w-[100px]">${item['券商']}</span>
                        <span class="ml-auto px-3 py-0.5 rounded font-bold text-xs ${rateColor}">${item['投資評等'] || 'N/A'}</span>
                    </div>

                    <div class="bg-slate-50 p-3 rounded-lg mb-4 border border-slate-100 flex-grow">
                        <p class="text-slate-700 text-base leading-relaxed line-clamp-3">
                            ${item['精簡重點摘要'] || '暫無摘要'}
                        </p>
                    </div>

                    <div class="pt-3 border-t border-gray-100 flex justify-between items-center">
                        <div class="text-sm text-gray-500 font-bold">目標價: <span class="font-bold text-slate-900 text-xl">${item['目標價'] || '--'}</span></div>
                        <button class="text-blue-600 font-bold text-sm hover:underline">閱讀詳情 &rarr;</button>
                    </div>
                </div>`;
            }, 'reportsPagination');
        }

        // 3. 外資快訊
        function renderNews() {
            const key = document.getElementById('searchNews').value.toLowerCase();
            
            const filtered = DB.news.filter(item => {
                const content = (item['標題'] + item['完整報導內容'] + (item['標籤']||'')).toLowerCase();
                return content.includes(key);
            });

            renderList('newsList', filtered, (item) => {
                const title = item['標題']; 
                const date = item['日期'] || '--';
                const content = item['完整報導內容'] || '無內容';
                
                let tagHtml = '';
                if(item['標籤']) {
                    tagHtml = item['標籤'].split(' ').map(t => 
                        `<span class="tag-pill bg-red-50 text-red-600 border border-red-100">${t.replace('#','')}</span>`
                    ).join('');
                }

                return `
                <div class="bg-white p-6 rounded-xl border border-gray-200 hover:border-red-300 hover:shadow-md transition cursor-pointer group" onclick="openModal('news', this.dataset.json)" data-json='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="w-32 flex-shrink-0">
                            <div class="text-sm font-bold text-gray-400 font-mono mb-1">${date}</div>
                            <div class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded inline-block">${item['券商來源'] || '快訊'}</div>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-slate-900 mb-2 group-hover:text-red-600 transition">${title}</h4>
                            <p class="text-slate-600 text-base line-clamp-2 mb-3">${content}</p>
                            <div class="flex flex-wrap gap-2">${tagHtml}</div>
                        </div>
                        <div class="flex items-center justify-center">
                            <i class="fa-solid fa-chevron-right text-gray-300 text-xl group-hover:text-red-400"></i>
                        </div>
                    </div>
                </div>`;
            }, 'newsPagination');
        }

        function renderPagination(id, total) {
            const container = document.getElementById(id);
            const pages = Math.ceil(total / PAGE_SIZE);
            if(pages <= 1) { container.innerHTML = ''; return; }

            let html = '';
            if(APP.page > 1) html += `<button onclick="APP.page--; refreshCurrentView()" class="w-10 h-10 rounded-lg bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 font-bold"><</button>`;
            html += `<span class="px-4 h-10 flex items-center bg-white border border-gray-300 rounded-lg text-gray-700 font-bold">第 ${APP.page} / ${pages} 頁</span>`;
            if(APP.page < pages) html += `<button onclick="APP.page++; refreshCurrentView()" class="w-10 h-10 rounded-lg bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 font-bold">></button>`;
            container.innerHTML = html;
        }

        function refreshCurrentView() {
            if(APP.currentView === 'industry') renderIndustry();
            if(APP.currentView === 'reports') renderReports();
            if(APP.currentView === 'news') renderNews();
            document.getElementById('mainContainer').scrollTo({top: 0, behavior: 'smooth'});
        }

        // === Modal 詳細頁 (增強版) ===
        function openModal(type, jsonStr) {
            const item = JSON.parse(jsonStr);
            const modal = document.getElementById('detailModal');
            
            const domCat = document.getElementById('mCategory');
            const domTitle = document.getElementById('mTitle');
            const domSub1 = document.getElementById('mSubtitle1');
            const domSub2 = document.getElementById('mSubtitle2');
            const domContent = document.getElementById('mContent');

            let html = '';

            if(type === 'report') {
                domCat.innerText = "投資研究報告";
                domCat.className = "text-sm font-bold uppercase mb-2 block px-3 py-1 rounded w-fit bg-yellow-100 text-yellow-800";
                domTitle.innerText = `${item['公司']} (${item['股號']})`;
                domSub1.innerText = item['券商'];
                domSub2.innerText = item['報告日期'];

                // 報告上方數據卡
                html += `<div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"><div class="text-xs text-gray-500 font-bold">評等</div><div class="text-xl font-bold text-slate-900">${item['投資評等']}</div></div>
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200 text-center"><div class="text-xs text-green-700 font-bold">目標價</div><div class="text-xl font-bold text-green-700">${item['目標價']}</div></div>
                    <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-center"><div class="text-xs text-yellow-700 font-bold">重要性</div><div class="text-xl text-yellow-500 overflow-hidden whitespace-nowrap">${item['重要性'] || '⭐⭐'}</div></div>
                </div>`;
                
                const makeSection = (title, text, color='blue') => {
                    if(!text) return '';
                    return `<div class="mb-8">
                        <h4 class="text-lg font-bold text-slate-900 mb-3 border-l-4 border-${color}-500 pl-3">${title}</h4>
                        <div class="text-body text-lg text-slate-700 bg-gray-50 p-5 rounded-xl border border-gray-200 leading-relaxed whitespace-pre-line">${text}</div>
                    </div>`;
                };

                html += makeSection('精簡重點摘要', item['精簡重點摘要'], 'blue');
                
                // 注入財務數據
                if (item['關鍵財務數據']) {
                    html += `<div class="mb-8">
                        <h4 class="text-lg font-bold text-slate-900 mb-3 border-l-4 border-purple-500 pl-3">關鍵財務數據</h4>
                        <div class="text-lg text-slate-800 bg-purple-50 p-5 rounded-xl border border-purple-100 font-mono leading-relaxed whitespace-pre-line">
                            ${item['關鍵財務數據']}
                        </div>
                    </div>`;
                }

                html += makeSection('營運重點', item['營運重點'], 'green');
                html += makeSection('Rex 大叔觀察', item['Rex觀察'], 'yellow');

            } else if(type === 'news') {
                domCat.innerText = "外資市場快訊";
                domCat.className = "text-sm font-bold uppercase mb-2 block px-3 py-1 rounded w-fit bg-red-100 text-red-800";
                domTitle.innerText = item['標題'];
                domSub1.innerText = item['券商來源'] || '市場消息';
                domSub2.innerText = item['日期'];

                const content = item['完整報導內容'] || '';
                html += `<div class="text-lg text-slate-800 leading-loose whitespace-pre-line font-medium bg-white p-2">${content}</div>`;
                
                if(item['標籤']) {
                    html += `<div class="mt-8 pt-4 border-t border-gray-200 flex gap-2">
                        ${item['標籤'].split(' ').map(t=>`<span class="bg-gray-200 text-gray-700 px-3 py-1 rounded font-bold text-sm">#${t.replace('#','')}</span>`).join('')}
                    </div>`;
                }

            } else { // Industry
                domCat.innerText = "產業百科";
                domCat.className = "text-sm font-bold uppercase mb-2 block px-3 py-1 rounded w-fit bg-blue-100 text-blue-800";
                domTitle.innerText = `${item['名稱']} (${item['代號']})`;
                domSub1.innerText = item['產業'];
                domSub2.innerText = item['細產業'];
                
                html += `<div class="mb-6">
                    <h4 class="text-lg font-bold text-slate-900 mb-3 border-l-4 border-blue-500 pl-3">產業地位與產品</h4>
                    <div class="text-lg text-slate-700 leading-relaxed bg-blue-50 p-6 rounded-xl border border-blue-100 font-medium">
                        ${item['產業地位'] || '無資料'}
                    </div>
                </div>`;
            }

            domContent.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // 手機版選單控制
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            if (sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex');
                overlay.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
