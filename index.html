<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rex大叔的168台股投資教室 - 戰情中心</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f3f4f6; font-family: "Microsoft JhengHei", sans-serif; }
        .sidebar { min-height: 100vh; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .loading-spinner { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex">

    <aside class="sidebar w-64 bg-gray-900 text-white hidden md:block flex-shrink-0">
        <div class="p-6 text-center border-b border-gray-800">
            <h1 class="text-2xl font-bold text-yellow-500">Rex大叔</h1>
            <p class="text-sm text-gray-400 mt-1">168台股投資教室</p>
        </div>
        <nav class="mt-6">
            <a href="#" class="block py-3 px-6 bg-gray-800 border-l-4 border-yellow-500 text-white">
                <i class="fa-solid fa-chart-line mr-3"></i> 投資報告庫
            </a>
            <a href="#" class="block py-3 px-6 text-gray-400 hover:bg-gray-800 hover:text-white transition">
                <i class="fa-solid fa-newspaper mr-3"></i> 產業新聞
            </a>
            <a href="#" class="block py-3 px-6 text-gray-400 hover:bg-gray-800 hover:text-white transition">
                <i class="fa-solid fa-database mr-3"></i> 個股數據
            </a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="bg-white shadow-sm z-10 p-4 flex justify-between items-center">
            <button class="md:hidden text-gray-600"><i class="fa-solid fa-bars text-2xl"></i></button>
            <h2 class="text-xl font-bold text-gray-800">投資報告戰情中心</h2>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-500">資料來源：Rex大叔資料庫</span>
                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold">R</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6">
            
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="搜尋公司、股號、關鍵字..." class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <select id="industryFilter" class="md:w-48 p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="">所有產業</option>
                        </select>
                </div>
            </div>

            <div id="loading" class="flex justify-center items-center py-20">
                <div class="loading-spinner ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            </div>

            <div id="reportsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                </div>
        </div>
    </main>

    <script>
        // 設定檔案路徑 (GitHub Raw URL 或 本地檔名)
        const FILE_REPORTS = 'reports.xlsx';   // 報告主檔
        const FILE_INDUSTRY = 'industry.xlsx'; // 產業對照檔

        let allReports = [];
        let industryMap = {}; // 用來修復資料的對照表

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
        });

        async function loadData() {
            try {
                // 1. 同時讀取兩個 Excel 檔案
                // 注意：Excel 讀取需要用 arrayBuffer 格式
                const [industryRes, reportsRes] = await Promise.all([
                    fetch(FILE_INDUSTRY).then(res => res.arrayBuffer()),
                    fetch(FILE_REPORTS).then(res => res.arrayBuffer())
                ]);

                // 2. 處理 Industry 檔案 (建立對照表)
                const industryWb = XLSX.read(industryRes);
                const industryWs = industryWb.Sheets[industryWb.SheetNames[0]];
                const industryJson = XLSX.utils.sheet_to_json(industryWs);

                industryJson.forEach(row => {
                    // 假設欄位名稱是 '代號', '產業', '細產業'
                    // 我們用 '代號' (股號) 當作 Key
                    if (row['代號']) {
                        let stockId = row['代號'].toString().trim();
                        industryMap[stockId] = {
                            industry: row['產業'],
                            subIndustry: row['細產業']
                        };
                    }
                });
                console.log("產業對照表建立完成，共 " + Object.keys(industryMap).length + " 筆");

                // 3. 處理 Reports 檔案 (並進行資料修復)
                const reportsWb = XLSX.read(reportsRes);
                const reportsWs = reportsWb.Sheets[reportsWb.SheetNames[0]];
                const reportsJson = XLSX.utils.sheet_to_json(reportsWs);

                processReports(reportsJson);

            } catch (error) {
                console.error("讀取失敗:", error);
                document.getElementById('loading').innerHTML = 
                    `<div class="text-red-500 font-bold">資料載入失敗，請確認 reports.xlsx 和 industry.xlsx 檔案是否存在。</div>`;
            }
        }

        function processReports(data) {
            // 資料清洗與修復
            allReports = data.map(report => {
                let stockId = report['股號'] ? report['股號'].toString().trim() : '';
                let originalIndustry = report['產業']; // 這裡可能填錯 (例如填成公司名)
                let correctIndustry = originalIndustry; // 預設先用原本的
                let subIndustry = '';

                // ★★★ 自動修復邏輯 ★★★
                // 如果這筆報告有股號，且在對照表裡找得到
                if (stockId && industryMap[stockId]) {
                    correctIndustry = industryMap[stockId].industry; // 用正確的產業覆蓋
                    subIndustry = industryMap[stockId].subIndustry;  // 順便補上細產業
                } else {
                    // 如果找不到對照 (例如前五篇沒股號)，且欄位看起來像公司名，就標示未分類
                    if (report['產業'] === report['公司']) {
                         correctIndustry = '未分類/待確認';
                    }
                }

                return {
                    ...report,
                    '產業': correctIndustry, // 這是修復後的正確產業
                    '細產業': subIndustry,
                    '股號': stockId
                };
            });

            // 初始化畫面
            initIndustryFilter();
            renderReports(allReports);
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('reportsContainer').classList.remove('hidden');
        }

        function initIndustryFilter() {
            const industrySet = new Set();
            allReports.forEach(r => {
                if(r['產業']) industrySet.add(r['產業']);
            });
            
            const select = document.getElementById('industryFilter');
            Array.from(industrySet).sort().forEach(ind => {
                const option = document.createElement('option');
                option.value = ind;
                option.textContent = ind;
                select.appendChild(option);
            });
        }

        function renderReports(reports) {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '';

            if (reports.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">找不到符合的資料</div>';
                return;
            }

            reports.forEach(report => {
                // 處理星星評等
                const stars = report['重要性'] || '⭐⭐⭐';
                
                // 處理標籤 (Tag)
                let tagsHtml = '';
                if (report['標籤']) {
                    tagsHtml = report['標籤'].toString().split('#')
                        .filter(t => t.trim() !== '')
                        .map(t => `<span class="inline-block bg-blue-50 text-blue-600 text-xs px-2 py-1 rounded-full mr-1 mb-1">#${t.trim()}</span>`)
                        .join('');
                }

                // 處理細產業標籤
                let subIndHtml = '';
                if (report['細產業']) {
                    subIndHtml = `<span class="inline-block bg-green-50 text-green-700 text-xs px-2 py-1 rounded border border-green-100 mb-2">${report['細產業']}</span>`;
                }

                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden card-hover flex flex-col h-full';
                
                card.innerHTML = `
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-gray-800 text-white text-xs font-bold px-2 py-1 rounded">${report['產業'] || '未分類'}</span>
                            <span class="text-xs text-gray-400">${report['報告日期'] || ''}</span>
                        </div>
                        
                        <div class="flex items-baseline gap-2 mb-1">
                            <h3 class="text-lg font-bold text-gray-800">${report['公司'] || '未知'} <span class="text-gray-400 text-sm font-normal">(${report['股號'] || 'N/A'})</span></h3>
                        </div>

                        ${subIndHtml}

                        <div class="flex items-center gap-2 mb-3 text-sm">
                            <span class="text-yellow-500 text-xs">${stars}</span>
                            <span class="text-gray-500 font-medium border px-2 rounded text-xs">${report['券商'] || '綜合'}</span>
                            ${report['投資評等'] ? `<span class="text-red-500 font-bold border border-red-100 bg-red-50 px-2 rounded text-xs">${report['投資評等']}</span>` : ''}
                        </div>

                        <div class="mb-4 flex-grow">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">精簡重點摘要</h4>
                            <p class="text-gray-600 text-sm leading-relaxed line-clamp-4 hover:line-clamp-none transition-all cursor-pointer bg-gray-50 p-2 rounded">
                                ${report['精簡重點摘要'] || '暫無摘要'}
                            </p>
                        </div>

                        <div class="flex flex-wrap gap-1 mt-auto">
                            ${tagsHtml}
                        </div>
                    </div>
                    <div class="bg-gray-50 px-5 py-3 border-t border-gray-100 flex justify-between items-center">
                        <div class="text-xs text-gray-500">
                            目標價: <span class="font-bold text-gray-800 text-base">${report['目標價'] || '--'}</span>
                        </div>
                        <button class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                            查看詳情 <i class="fa-solid fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const industryFilter = document.getElementById('industryFilter');

            function filterData() {
                const keyword = searchInput.value.toLowerCase();
                const industry = industryFilter.value;

                const filtered = allReports.filter(report => {
                    // 確保欄位是字串再進行比對
                    const company = (report['公司'] || '').toString().toLowerCase();
                    const stockId = (report['股號'] || '').toString();
                    const summary = (report['精簡重點摘要'] || '').toString().toLowerCase();
                    const tags = (report['標籤'] || '').toString().toLowerCase();

                    const matchKeyword = (
                        company.includes(keyword) ||
                        stockId.includes(keyword) ||
                        summary.includes(keyword) ||
                        tags.includes(keyword)
                    );
                    const matchIndustry = industry === '' || report['產業'] === industry;
                    return matchKeyword && matchIndustry;
                });

                renderReports(filtered);
            }

            searchInput.addEventListener('input', filterData);
            industryFilter.addEventListener('change', filterData);
        }
    </script>
</body>
</html>
