<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rex大叔的168智能投資戰情室</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .scroller::-webkit-scrollbar { width: 8px; }
        .scroller::-webkit-scrollbar-track { background: #1e293b; }
        .scroller::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .highlight-text { color: #38bdf8; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // 圖標組件
        const Icon = ({ name, size = 16, className }) => {
            const icons = {
                search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
                fileText: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
                trendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
                info: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
                star: <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            };
            return <span className={`inline-flex items-center ${className}`}>{icons[name] || icons.info}</span>;
        };

        // 檔案上傳組件
        const FileUploader = ({ onDataLoaded }) => {
            const handleFileUpload = (event, type) => {
                const file = event.target.files[0];
                if (file) {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            onDataLoaded(type, results.data);
                        }
                    });
                }
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-6 glass-panel rounded-xl">
                    <div className="text-center">
                        <label className="block text-sm font-medium text-gray-400 mb-2">1. 報告詳細庫 (reports.xlsx)</label>
                        <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'reports')} className="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"/>
                    </div>
                    <div className="text-center">
                        <label className="block text-sm font-medium text-gray-400 mb-2">2. 產業分類 (industry.xlsx)</label>
                        <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'industry')} className="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700"/>
                    </div>
                    <div className="text-center">
                        <label className="block text-sm font-medium text-gray-400 mb-2">3. 外電新聞 (news.xlsx)</label>
                        <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'news')} className="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700"/>
                    </div>
                </div>
            );
        };

        // 星級顯示組件
        const StarRating = ({ rating }) => {
            if (!rating) return null;
            // 計算星星數量，這裡簡單判斷字串長度或特定符號
            const stars = rating.includes('⭐') ? rating.match(/⭐/g).length : 0;
            return (
                <div className="flex text-yellow-400">
                    {[...Array(stars)].map((_, i) => <Icon key={i} name="star" size={14} />)}
                </div>
            );
        };

        // 標籤顯示組件
        const TagList = ({ tags }) => {
            if (!tags) return null;
            const tagArray = tags.split(' ').filter(t => t.startsWith('#'));
            return (
                <div className="flex flex-wrap gap-2 mt-2">
                    {tagArray.map((tag, i) => (
                        <span key={i} className="px-2 py-1 text-xs bg-slate-700 text-blue-300 rounded-md border border-slate-600">
                            {tag}
                        </span>
                    ))}
                </div>
            );
        };

        // 股票詳情卡片 (核心分析區)
        const StockDetailView = ({ stockCode, industryData, reportsData, newsData, onClose }) => {
            // 整合資料：找到該股號的所有相關資料
            const industryInfo = industryData.find(i => i['代號'] === stockCode) || {};
            const stockReports = reportsData.filter(r => r['股號'] === stockCode);
            const stockNews = newsData.filter(n => n['股號'] === stockCode);

            // 找到最新的一份報告作為主顯示
            const latestReport = stockReports.length > 0 ? stockReports[0] : null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 overflow-auto">
                    <div className="bg-slate-900 w-full max-w-6xl max-h-[90vh] rounded-2xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden">
                        
                        {/* Header */}
                        <div className="p-6 border-b border-slate-700 flex justify-between items-start bg-slate-800">
                            <div>
                                <div className="flex items-center gap-3">
                                    <h2 className="text-3xl font-bold text-white">{stockCode} {industryInfo['名稱'] || latestReport?.['公司'] || '未知名稱'}</h2>
                                    {industryInfo['產業'] && <span className="px-3 py-1 bg-blue-900 text-blue-200 text-sm rounded-full">{industryInfo['產業']}</span>}
                                    {industryInfo['細產業'] && <span className="px-3 py-1 bg-slate-700 text-slate-300 text-sm rounded-full">{industryInfo['細產業']}</span>}
                                </div>
                                <div className="mt-2 text-slate-400 font-medium text-lg">
                                    {industryInfo['產業地位'] || '尚無產業地位資料'}
                                </div>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-2 hover:bg-slate-700 rounded-full">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>

                        {/* Body - 三欄式佈局 */}
                        <div className="flex-1 overflow-y-auto scroller p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                            
                            {/* 左側：最新深度報告 (佔 5 欄) */}
                            <div className="lg:col-span-5 space-y-6">
                                <div className="flex items-center gap-2 mb-4">
                                    <Icon name="fileText" className="text-blue-400" size={24} />
                                    <h3 className="text-xl font-bold text-white">最新研究報告深度分析</h3>
                                </div>

                                {latestReport ? (
                                    <div className="space-y-6">
                                        <div className="glass-panel p-5 rounded-lg border-l-4 border-blue-500">
                                            <div className="flex justify-between items-center mb-3">
                                                <span className="text-slate-400 text-sm">{latestReport['報告日期']} | {latestReport['券商']}</span>
                                                <StarRating rating={latestReport['重要性']} />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div className="bg-slate-800 p-3 rounded">
                                                    <div className="text-slate-400 text-xs">投資評等</div>
                                                    <div className="text-lg font-bold text-white">{latestReport['投資評等']}</div>
                                                </div>
                                                <div className="bg-slate-800 p-3 rounded">
                                                    <div className="text-slate-400 text-xs">目標價</div>
                                                    <div className="text-lg font-bold text-green-400">{latestReport['目標價']}</div>
                                                </div>
                                            </div>
                                            
                                            {/* Rex大叔觀察 - 重點強調 */}
                                            {latestReport['Rex觀察'] && (
                                                <div className="bg-indigo-900/30 p-4 rounded-lg border border-indigo-500/30 mb-4">
                                                    <h4 className="text-indigo-300 font-bold mb-2 flex items-center gap-2">
                                                        <Icon name="search" size={16} /> Rex大叔觀察
                                                    </h4>
                                                    <p className="text-indigo-100 leading-relaxed whitespace-pre-line text-sm">{latestReport['Rex觀察']}</p>
                                                </div>
                                            )}
                                        </div>

                                        {/* 詳細欄位 */}
                                        <div className="space-y-4">
                                            {[
                                                { title: "精簡重點摘要", content: latestReport['精簡重點摘要'], color: "text-slate-200" },
                                                { title: "關鍵財務數據", content: latestReport['關鍵財務數據'], color: "text-yellow-100" },
                                                { title: "營運重點", content: latestReport['營運重點'], color: "text-slate-300" },
                                                { title: "策略方向", content: latestReport['策略方向'], color: "text-slate-300" },
                                                { title: "重要QA摘要", content: latestReport['重要QA摘要'], color: "text-slate-300" }
                                            ].map((section, idx) => (
                                                section.content && (
                                                    <div key={idx} className="glass-panel p-4 rounded-lg">
                                                        <h4 className="text-blue-400 text-sm font-bold mb-2 uppercase tracking-wider">{section.title}</h4>
                                                        <p className={`${section.color} text-sm leading-relaxed whitespace-pre-line`}>{section.content}</p>
                                                    </div>
                                                )
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-slate-500 text-center py-10">此公司尚無詳細報告資料</div>
                                )}
                            </div>

                            {/* 中間：外電新聞追蹤 (佔 4 欄) */}
                            <div className="lg:col-span-4 space-y-4">
                                <div className="flex items-center gap-2 mb-4">
                                    <Icon name="trendingUp" className="text-purple-400" size={24} />
                                    <h3 className="text-xl font-bold text-white">外電與動態追蹤</h3>
                                </div>
                                
                                <div className="space-y-3 max-h-[800px] overflow-y-auto scroller pr-2">
                                    {stockNews.length > 0 ? stockNews.map((news, idx) => (
                                        <div key={idx} className="glass-panel p-4 rounded-lg hover:bg-slate-800 transition-colors">
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="text-xs text-purple-300 border border-purple-500/30 px-2 py-0.5 rounded">{news['券商來源']}</span>
                                                <span className="text-xs text-slate-400">{news['日期']}</span>
                                            </div>
                                            <h5 className="font-bold text-white mb-2">{news['報導重點分類']}</h5>
                                            <p className="text-slate-300 text-sm mb-3 line-clamp-4 hover:line-clamp-none transition-all">{news['完整報導內容']}</p>
                                            <TagList tags={news['標籤']} />
                                            <div className="mt-2 flex justify-end">
                                                 <StarRating rating={news['重要性']} />
                                            </div>
                                        </div>
                                    )) : (
                                        <div className="text-slate-500 text-center py-10">尚無外電報導</div>
                                    )}
                                </div>
                            </div>

                            {/* 右側：歷史報告列表 (佔 3 欄) */}
                            <div className="lg:col-span-3 space-y-4">
                                <div className="flex items-center gap-2 mb-4">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-green-400"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>
                                    <h3 className="text-xl font-bold text-white">報告歷史存擋</h3>
                                </div>
                                <div className="space-y-2">
                                    {stockReports.map((report, idx) => (
                                        <div key={idx} className="bg-slate-800 p-3 rounded cursor-pointer hover:bg-slate-700 border border-slate-700">
                                            <div className="flex justify-between mb-1">
                                                <span className="text-xs text-green-400">{report['報告日期']}</span>
                                                <span className="text-xs text-slate-400">{report['券商']}</span>
                                            </div>
                                            <div className="font-bold text-sm text-white mb-1">{report['分析師']}</div>
                                            <div className="flex items-center justify-between text-xs">
                                                <span className="text-slate-300">TP: {report['目標價']}</span>
                                                <span className="text-slate-300">{report['投資評等']}</span>
                                            </div>
                                        </div>
                                    ))}
                                    {stockReports.length === 0 && <div className="text-slate-500 text-center">無歷史報告</div>}
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        // 主程式
        const App = () => {
            const [data, setData] = useState({ reports: [], industry: [], news: [] });
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedStock, setSelectedStock] = useState(null);

            const handleDataLoaded = (type, loadedData) => {
                setData(prev => ({ ...prev, [type]: loadedData }));
            };

            // 計算整合列表：找出所有出現過的股票代碼
            const uniqueStocks = useMemo(() => {
                const stocks = new Set();
                data.reports.forEach(r => r['股號'] && stocks.add(r['股號']));
                data.industry.forEach(i => i['代號'] && stocks.add(i['代號']));
                data.news.forEach(n => n['股號'] && stocks.add(n['股號']));
                return Array.from(stocks);
            }, [data]);

            // 過濾邏輯
            const filteredStocks = uniqueStocks.filter(code => {
                if (!searchTerm) return true;
                
                // 取得該代碼的相關名稱以供搜尋
                const ind = data.industry.find(i => i['代號'] === code);
                const rep = data.reports.find(r => r['股號'] === code);
                const name = ind?.['名稱'] || rep?.['公司'] || '';
                
                return code.includes(searchTerm) || name.includes(searchTerm);
            }).slice(0, 50); // 限制顯示數量避免卡頓

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <header className="bg-slate-900 border-b border-slate-800 p-6 sticky top-0 z-40 shadow-lg">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
                                    Rex大叔的168智能投資戰情室
                                </h1>
                                <p className="text-slate-400 text-sm mt-1">投機天才的覺醒 - 資料驅動決策系統</p>
                            </div>
                            <div className="relative w-full md:w-96">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <Icon name="search" className="text-slate-500" />
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="輸入代號或名稱搜尋 (例如: 2330)..." 
                                    className="block w-full pl-10 pr-3 py-3 bg-slate-800 border border-slate-700 rounded-lg leading-5 text-slate-300 placeholder-slate-500 focus:outline-none focus:bg-slate-900 focus:border-blue-500 transition duration-150 ease-in-out shadow-inner"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-6">
                        
                        {/* 如果還沒載入資料，顯示上傳區 */}
                        {(!data.reports.length && !data.industry.length && !data.news.length) && (
                            <div className="mb-8">
                                <div className="bg-blue-900/20 border border-blue-500/30 p-4 rounded-lg mb-6 text-blue-200 text-center">
                                    請先載入 Rex 大叔的三個關鍵資料庫檔案 (.csv) 以啟動戰情室
                                </div>
                                <FileUploader onDataLoaded={handleDataLoaded} />
                            </div>
                        )}

                        {/* 統計數據 Dashboard */}
                        {(data.reports.length > 0) && (
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                <div className="glass-panel p-4 rounded-lg border-l-4 border-blue-500">
                                    <div className="text-slate-400 text-sm">資料庫總公司數</div>
                                    <div className="text-2xl font-bold text-white">{uniqueStocks.length}</div>
                                </div>
                                <div className="glass-panel p-4 rounded-lg border-l-4 border-green-500">
                                    <div className="text-slate-400 text-sm">深度報告篇數</div>
                                    <div className="text-2xl font-bold text-white">{data.reports.length}</div>
                                </div>
                                <div className="glass-panel p-4 rounded-lg border-l-4 border-purple-500">
                                    <div className="text-slate-400 text-sm">外電消息追蹤</div>
                                    <div className="text-2xl font-bold text-white">{data.news.length}</div>
                                </div>
                                <div className="glass-panel p-4 rounded-lg border-l-4 border-yellow-500">
                                    <div className="text-slate-400 text-sm">Rex 重點觀察</div>
                                    <div className="text-2xl font-bold text-white">{data.reports.filter(r => r['Rex觀察']).length}</div>
                                </div>
                            </div>
                        )}

                        {/* 股票列表 Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredStocks.map(code => {
                                const industry = data.industry.find(i => i['代號'] === code) || {};
                                const latestRep = data.reports.find(r => r['股號'] === code); // 假設已按日期排序或取第一筆
                                const latestNews = data.news.find(n => n['股號'] === code);
                                const name = industry['名稱'] || latestRep?.['公司'] || latestNews?.['公司'] || '未知';

                                // 如果沒有任何詳細資料，可能不顯示或是顯示空狀態
                                if (!latestRep && !industry['產業'] && !latestNews) return null;

                                return (
                                    <div key={code} 
                                         onClick={() => setSelectedStock(code)}
                                         className="glass-panel rounded-xl p-5 hover:bg-slate-800 hover:border-blue-500/50 transition-all cursor-pointer group shadow-lg hover:shadow-blue-500/10 flex flex-col justify-between h-full relative overflow-hidden">
                                        
                                        {/* 裝飾背景光 */}
                                        <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl -mr-10 -mt-10 group-hover:bg-blue-500/20 transition-all"></div>

                                        <div>
                                            <div className="flex justify-between items-start mb-3 relative z-10">
                                                <div>
                                                    <div className="text-2xl font-bold text-white flex items-center gap-2">
                                                        {code} <span className="text-lg font-normal text-slate-300">{name}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-400 mt-1 flex gap-2">
                                                        {industry['產業'] && <span className="bg-slate-700 px-2 py-0.5 rounded">{industry['產業']}</span>}
                                                        {latestRep && <span className="bg-blue-900/50 text-blue-300 px-2 py-0.5 rounded">有報告</span>}
                                                    </div>
                                                </div>
                                                {latestRep && <div className="text-right">
                                                    <div className="text-xs text-slate-500">評等</div>
                                                    <div className={`font-bold ${latestRep['投資評等']?.includes('Buy') || latestRep['投資評等']?.includes('買進') ? 'text-red-400' : 'text-yellow-400'}`}>
                                                        {latestRep['投資評等']?.substring(0, 6)}
                                                    </div>
                                                </div>}
                                            </div>

                                            {/* 產業地位摘要 */}
                                            {industry['產業地位'] && (
                                                <div className="mb-4 p-2 bg-slate-900/50 rounded border border-slate-700/50">
                                                    <p className="text-slate-400 text-xs line-clamp-2">{industry['產業地位']}</p>
                                                </div>
                                            )}

                                            {/* 最新動態摘要 */}
                                            <div className="space-y-2">
                                                {latestRep && (
                                                    <div className="flex items-start gap-2">
                                                        <Icon name="fileText" className="text-blue-500 mt-0.5 flex-shrink-0" size={14} />
                                                        <p className="text-sm text-slate-300 line-clamp-2">{latestRep['精簡重點摘要']?.substring(0, 50)}...</p>
                                                    </div>
                                                )}
                                                {latestNews && !latestRep && (
                                                    <div className="flex items-start gap-2">
                                                        <Icon name="trendingUp" className="text-purple-500 mt-0.5 flex-shrink-0" size={14} />
                                                        <p className="text-sm text-slate-300 line-clamp-2">{latestNews['報導重點分類']}...</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="mt-4 pt-4 border-t border-slate-700/50 flex justify-between items-center">
                                            <span className="text-xs text-slate-500">點擊查看完整戰情</span>
                                            {latestRep?.['Rex觀察'] && <span className="text-xs text-indigo-400 font-bold flex items-center gap-1"><Icon name="search" size={12}/> Rex 關注</span>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {/* 彈出詳細視窗 */}
                    {selectedStock && (
                        <StockDetailView 
                            stockCode={selectedStock} 
                            industryData={data.industry} 
                            reportsData={data.reports} 
                            newsData={data.news} 
                            onClose={() => setSelectedStock(null)} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
