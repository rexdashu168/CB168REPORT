<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ - æ™ºèƒ½æˆ°æƒ…ä¸­å¿ƒ</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* å…¨å±€è¨­å®š */
        body { background-color: #f3f4f6; font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; }
        
        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* å¡ç‰‡ç‰¹æ•ˆ */
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .tag-pill { background-color: #eff6ff; color: #2563eb; font-size: 0.75rem; padding: 2px 8px; border-radius: 9999px; border: 1px solid #dbeafe; white-space: nowrap; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading-spinner { border-top-color: #eab308; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å½ˆçª—å‹•ç•« */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-gray-900 text-white flex-shrink-0 hidden md:flex flex-col shadow-xl relative z-20">
        <div class="p-6 text-center border-b border-gray-800">
            <div class="mb-3 inline-block p-3 rounded-full bg-gray-800 text-yellow-500 shadow-inner">
                <i class="fa-solid fa-chart-line text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-yellow-500 tracking-wider">Rexå¤§å”</h1>
            <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest">168 æŠ•è³‡æˆ°æƒ…å®¤</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-4 mb-2 text-xs text-gray-500 font-bold uppercase">ä¸»è¦åŠŸèƒ½</div>
            <a href="#" class="flex items-center py-3 px-6 bg-gray-800 border-r-4 border-yellow-500 text-white mb-1">
                <i class="fa-solid fa-file-invoice-dollar w-6 text-center mr-3 text-yellow-500"></i>
                <span class="font-medium">æŠ•è³‡å ±å‘Šåº«</span>
            </a>
            <a href="#" class="flex items-center py-3 px-6 text-gray-400 hover:bg-gray-800 hover:text-white transition mb-1">
                <i class="fa-solid fa-newspaper w-6 text-center mr-3"></i>
                <span>ç”¢æ¥­æ–°èå¿«è¨Š</span>
            </a>
            <a href="#" class="flex items-center py-3 px-6 text-gray-400 hover:bg-gray-800 hover:text-white transition mb-1">
                <i class="fa-solid fa-database w-6 text-center mr-3"></i>
                <span>å€‹è‚¡æ•¸æ“šåˆ†æ</span>
            </a>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <div class="bg-gray-800 rounded-lg p-4 text-xs text-gray-400">
                <p class="mb-2"><i class="fa-solid fa-circle-info mr-2"></i>ç³»çµ±ç‹€æ…‹</p>
                <div class="flex justify-between items-center">
                    <span>è³‡æ–™åº«é€£ç·š</span>
                    <span class="text-green-500"><i class="fa-solid fa-circle text-[8px] mr-1"></i>æ­£å¸¸</span>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50 relative">
        
        <header class="bg-white shadow-sm z-10 px-6 py-3 flex justify-between items-center h-16">
            <div class="flex items-center md:hidden">
                <button class="text-gray-600 mr-4"><i class="fa-solid fa-bars text-xl"></i></button>
                <span class="font-bold text-gray-800">Rexå¤§å”</span>
            </div>
            <h2 class="hidden md:block text-lg font-bold text-gray-700">
                <i class="fa-solid fa-layer-group mr-2 text-blue-500"></i>
                å…¨æ–¹ä½å€‹è‚¡ç ”ç©¶å ±å‘Šç³»çµ±
            </h2>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                    <i class="fa-regular fa-calendar mr-2"></i><span id="currentDate"></span>
                </span>
                <div class="w-9 h-9 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white font-bold shadow-md border-2 border-white">R</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="dashboardStats">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-8">
                <div class="flex flex-col gap-4">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="æ™ºèƒ½æœå°‹ï¼šè¼¸å…¥è‚¡è™Ÿã€å…¬å¸åã€é—œéµå­— (ä¾‹å¦‚: 2330, AIä¼ºæœå™¨, è²·é€²)..." 
                               class="w-full pl-11 pr-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 bg-gray-50 focus:bg-white transition text-gray-700 placeholder-gray-400">
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <select id="industryFilter" class="p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white text-gray-600">
                            <option value="">ğŸ¢ æ‰€æœ‰ç”¢æ¥­</option>
                            </select>
                        <select id="brokerFilter" class="p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white text-gray-600">
                            <option value="">ğŸ¦ æ‰€æœ‰åˆ¸å•†</option>
                            </select>
                        <select id="ratingFilter" class="p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white text-gray-600">
                            <option value="">ğŸ“Š æ‰€æœ‰è©•ç­‰</option>
                            </select>
                        <button id="resetBtn" class="p-2.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition flex items-center justify-center font-medium">
                            <i class="fa-solid fa-rotate-right mr-2"></i> é‡ç½®ç¯©é¸
                        </button>
                    </div>
                </div>
            </div>

            <div id="loading" class="flex flex-col justify-center items-center py-20">
                <div class="loading-spinner ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                <p class="text-gray-500 font-medium">æ­£åœ¨é€£æ¥ Rex å¤§å”è³‡æ–™åº«...</p>
            </div>

            <div id="reportsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                </div>
        </div>
    </main>

    <div id="detailModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>

        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border-t-4 border-yellow-500">
                
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h3 class="text-2xl font-bold text-gray-900" id="modalTitle">å…¬å¸åç¨±</h3>
                            <span class="px-2 py-0.5 rounded text-sm font-mono bg-gray-200 text-gray-700" id="modalStockId">0000</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <span id="modalDate"><i class="fa-regular fa-clock mr-1"></i>æ—¥æœŸ</span>
                            <span class="mx-1">|</span>
                            <span id="modalBroker">åˆ¸å•†</span>
                        </div>
                    </div>
                    <button type="button" class="text-gray-400 hover:text-gray-600 bg-white rounded-full p-1 hover:bg-gray-100 transition" onclick="closeModal()">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-center">
                            <div class="text-xs text-blue-500 mb-1 font-bold">æŠ•è³‡è©•ç­‰</div>
                            <div class="text-lg font-bold text-blue-700" id="modalRating">--</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border border-green-100 text-center">
                            <div class="text-xs text-green-600 mb-1 font-bold">ç›®æ¨™åƒ¹</div>
                            <div class="text-lg font-bold text-green-800" id="modalTarget">--</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 text-center col-span-2 md:col-span-2">
                            <div class="text-xs text-purple-600 mb-1 font-bold">é‡è¦æ€§</div>
                            <div class="text-yellow-500 text-lg" id="modalImportance">â­â­â­</div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="content-block">
                            <h4 class="flex items-center text-gray-800 font-bold border-l-4 border-blue-500 pl-3 mb-3">
                                ğŸ” ç²¾ç°¡é‡é»æ‘˜è¦
                            </h4>
                            <p class="text-gray-600 leading-relaxed text-justify bg-gray-50 p-4 rounded-lg text-sm" id="modalSummary"></p>
                        </div>

                        <div class="content-block" id="blockHighlight">
                            <h4 class="flex items-center text-gray-800 font-bold border-l-4 border-green-500 pl-3 mb-3">
                                ğŸ“ˆ ç‡Ÿé‹é‡é»
                            </h4>
                            <p class="text-gray-600 leading-relaxed text-justify bg-gray-50 p-4 rounded-lg text-sm" id="modalHighlights"></p>
                        </div>

                        <div class="content-block" id="blockRex">
                            <h4 class="flex items-center text-gray-800 font-bold border-l-4 border-yellow-500 pl-3 mb-3">
                                ğŸ’¡ Rex å¤§å”è§€å¯Ÿ
                            </h4>
                            <div class="text-gray-700 leading-relaxed text-justify bg-yellow-50 border border-yellow-100 p-4 rounded-lg text-sm" id="modalRexObs"></div>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-gray-100">
                        <div class="flex flex-wrap gap-2" id="modalTags"></div>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse">
                    <button type="button" class="inline-flex w-full justify-center rounded-md bg-gray-800 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-700 sm:ml-3 sm:w-auto transition" onclick="closeModal()">
                        é—œé–‰è¦–çª—
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®šç•¶å‰æ—¥æœŸ
        const now = new Date();
        document.getElementById('currentDate').textContent = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;

        // æª”æ¡ˆè¨­å®š (è«‹ç¢ºä¿æª”åæ­£ç¢º)
        const FILE_REPORTS = 'reports.xlsx';
        const FILE_INDUSTRY = 'industry.xlsx';

        let allReports = [];
        let industryMap = {}; 
        let filteredReports = [];

        // å•Ÿå‹•
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // ç¶å®šç¯©é¸äº‹ä»¶
            ['searchInput', 'industryFilter', 'brokerFilter', 'ratingFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFilters);
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('industryFilter').value = '';
                document.getElementById('brokerFilter').value = '';
                document.getElementById('ratingFilter').value = '';
                applyFilters();
            });
        });

        // è®€å–ä¸¦è§£æè³‡æ–™
        async function loadData() {
            try {
                const [industryRes, reportsRes] = await Promise.all([
                    fetch(FILE_INDUSTRY).then(res => res.arrayBuffer()),
                    fetch(FILE_REPORTS).then(res => res.arrayBuffer())
                ]);

                // 1. è™•ç† Industry Map
                const indWb = XLSX.read(industryRes);
                const indJson = XLSX.utils.sheet_to_json(indWb.Sheets[indWb.SheetNames[0]]);
                indJson.forEach(row => {
                    if(row['ä»£è™Ÿ']) {
                        const id = row['ä»£è™Ÿ'].toString().trim();
                        industryMap[id] = {
                            industry: row['ç”¢æ¥­'] || 'æœªåˆ†é¡',
                            subIndustry: row['ç´°ç”¢æ¥­']
                        };
                    }
                });

                // 2. è™•ç† Reports (è³‡æ–™æ¸…æ´—)
                const repWb = XLSX.read(reportsRes);
                const repJson = XLSX.utils.sheet_to_json(repWb.Sheets[repWb.SheetNames[0]]);

                allReports = repJson.map((row, index) => {
                    const stockId = row['è‚¡è™Ÿ'] ? row['è‚¡è™Ÿ'].toString().trim() : '';
                    let industry = row['ç”¢æ¥­'];
                    let subIndustry = '';

                    // è‡ªå‹•ä¿®å¾©ç”¢æ¥­æ¬„ä½
                    if(stockId && industryMap[stockId]) {
                        industry = industryMap[stockId].industry;
                        subIndustry = industryMap[stockId].subIndustry;
                    } else if(industry === row['å…¬å¸']) {
                        industry = 'å¾…ç¢ºèª';
                    }

                    return {
                        id: index,
                        stockId: stockId,
                        company: row['å…¬å¸'] || 'æœªçŸ¥',
                        date: row['å ±å‘Šæ—¥æœŸ'] || '',
                        broker: row['åˆ¸å•†'] || 'ç¶œåˆ',
                        analyst: row['åˆ†æå¸«'] || '',
                        type: row['å ±å‘Šé¡å‹'] || '',
                        rating: row['æŠ•è³‡è©•ç­‰'] || '',
                        targetPrice: row['ç›®æ¨™åƒ¹'] || '--',
                        importance: row['é‡è¦æ€§'] || 'â­â­',
                        industry: industry || 'æœªåˆ†é¡',
                        subIndustry: subIndustry || '',
                        summary: row['ç²¾ç°¡é‡é»æ‘˜è¦'] || '',
                        highlights: row['ç‡Ÿé‹é‡é»'] || '',
                        strategy: row['ç­–ç•¥æ–¹å‘'] || '',
                        qa: row['é‡è¦QAæ‘˜è¦'] || '',
                        rexObs: row['Rexè§€å¯Ÿ'] || '', // å‡è¨­ Excel æ¬„ä½æ˜¯é€™å€‹
                        tags: row['æ¨™ç±¤'] || ''
                    };
                });

                // åˆå§‹åŒ–
                initFilters();
                updateDashboardStats(allReports);
                renderReports(allReports);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('reportsContainer').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                document.getElementById('loading').innerHTML = `
                    <div class="text-red-500 font-bold bg-red-50 p-4 rounded-lg border border-red-200">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                        è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª reports.xlsx å’Œ industry.xlsx æ˜¯å¦å­˜åœ¨ã€‚
                    </div>`;
            }
        }

        // åˆå§‹åŒ–ç¯©é¸é¸å–®
        function initFilters() {
            const industries = new Set();
            const brokers = new Set();
            const ratings = new Set();

            allReports.forEach(r => {
                if(r.industry) industries.add(r.industry);
                if(r.broker) brokers.add(r.broker);
                if(r.rating) ratings.add(r.rating);
            });

            populateSelect('industryFilter', industries);
            populateSelect('brokerFilter', brokers);
            populateSelect('ratingFilter', ratings);
        }

        function populateSelect(id, set) {
            const select = document.getElementById(id);
            Array.from(set).sort().forEach(val => {
                if(!val) return;
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                select.appendChild(opt);
            });
        }

        // æ›´æ–°å„€è¡¨æ¿æ•¸æ“š
        function updateDashboardStats(data) {
            const total = data.length;
            
            // è¨ˆç®—æœ€å¤šå ±å‘Šçš„ç”¢æ¥­
            const indCounts = {};
            data.forEach(r => { indCounts[r.industry] = (indCounts[r.industry] || 0) + 1; });
            const topInd = Object.entries(indCounts).sort((a,b) => b[1] - a[1])[0] || ['ç„¡', 0];

            // è¨ˆç®—çœ‹å¤šæ¯”ä¾‹ (è©•ç­‰åŒ…å« "è²·" æˆ– "Buy")
            const buyCount = data.filter(r => r.rating && (r.rating.includes('è²·') || r.rating.includes('Buy') || r.rating.includes('å¢åŠ æŒè‚¡'))).length;
            const buyRate = total > 0 ? Math.round((buyCount / total) * 100) : 0;

            // éš¨æ©Ÿæˆ–å›ºå®šæœ€å¾Œä¸€å€‹æ•¸æ“š (ä¾‹å¦‚æœ¬é€±æ–°å¢)
            const weeklyNew = data.filter(r => {
                // ç°¡å–®æ¨¡æ“¬ï¼šå¦‚æœæœ‰æ—¥æœŸæ¬„ä½ï¼Œåˆ¤æ–·æ˜¯å¦ç‚ºè¿‘æœŸ (é€™è£¡å…ˆå¯«æ­»ä½œç¯„ä¾‹)
                return true; 
            }).length; 

            const statsHTML = `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between card-hover">
                    <div>
                        <p class="text-xs text-gray-500 mb-1 font-bold">å ±å‘Šç¸½æ•¸</p>
                        <h3 class="text-2xl font-bold text-gray-800">${total} <span class="text-xs text-gray-400 font-normal">ç¯‡</span></h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center">
                        <i class="fa-solid fa-file-lines"></i>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between card-hover">
                    <div>
                        <p class="text-xs text-gray-500 mb-1 font-bold">ç†±é–€ç”¢æ¥­</p>
                        <h3 class="text-xl font-bold text-gray-800 truncate w-32" title="${topInd[0]}">${topInd[0]}</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center">
                        <i class="fa-solid fa-industry"></i>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between card-hover">
                    <div>
                        <p class="text-xs text-gray-500 mb-1 font-bold">çœ‹å¤šæƒ…ç·’</p>
                        <h3 class="text-2xl font-bold text-red-500">${buyRate}% <span class="text-xs text-gray-400 font-normal">å æ¯”</span></h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center">
                        <i class="fa-solid fa-arrow-trend-up"></i>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between card-hover">
                    <div>
                        <p class="text-xs text-gray-500 mb-1 font-bold">æœ€æ–°æ›´æ–°</p>
                        <h3 class="text-xl font-bold text-gray-800">${data[0] ? data[0].date : '--'}</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-green-50 text-green-500 flex items-center justify-center">
                        <i class="fa-regular fa-calendar-check"></i>
                    </div>
                </div>
            `;
            
            document.getElementById('dashboardStats').innerHTML = statsHTML;
        }

        // ç¯©é¸é‚è¼¯
        function applyFilters() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const industry = document.getElementById('industryFilter').value;
            const broker = document.getElementById('brokerFilter').value;
            const rating = document.getElementById('ratingFilter').value;

            filteredReports = allReports.filter(r => {
                const matchKey = (
                    r.company.toLowerCase().includes(keyword) || 
                    r.stockId.includes(keyword) || 
                    r.summary.toLowerCase().includes(keyword) ||
                    r.tags.toLowerCase().includes(keyword)
                );
                const matchInd = industry === '' || r.industry === industry;
                const matchBrk = broker === '' || r.broker === broker;
                const matchRate = rating === '' || r.rating === rating;

                return matchKey && matchInd && matchBrk && matchRate;
            });

            // æ›´æ–°å„€è¡¨æ¿æ•¸æ“š (æ ¹æ“šç¯©é¸çµæœå‹•æ…‹è®ŠåŒ–)
            // updateDashboardStats(filteredReports); // å¦‚æœå¸Œæœ›ä¸Šæ–¹æ•¸æ“šéš¨ç¯©é¸è®Šå‹•å¯æ‰“é–‹
            
            renderReports(filteredReports);
        }

        // æ¸²æŸ“åˆ—è¡¨
        function renderReports(data) {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '';

            if(data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-300 mb-4"><i class="fa-solid fa-folder-open text-6xl"></i></div>
                        <p class="text-gray-500">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å ±å‘Š</p>
                    </div>`;
                return;
            }

            data.forEach(r => {
                // æ¨™ç±¤è™•ç†
                let tagsHTML = '';
                if(r.tags) {
                    tagsHTML = r.tags.split('#').filter(t=>t.trim()).slice(0,3).map(t => 
                        `<span class="tag-pill">#${t.trim()}</span>`
                    ).join('');
                }

                // è©•ç­‰é¡è‰²
                let rateClass = 'bg-gray-100 text-gray-600';
                if(r.rating.includes('è²·') || r.rating.includes('Buy') || r.rating.includes('å¢åŠ ')) rateClass = 'bg-red-50 text-red-600 border border-red-100';
                if(r.rating.includes('æŒæœ‰') || r.rating.includes('ä¸­ç«‹')) rateClass = 'bg-green-50 text-green-600 border border-green-100';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden card-hover flex flex-col h-full relative';
                // å­˜å…¥å®Œæ•´è³‡æ–™ä»¥ä¾¿ Modal ä½¿ç”¨
                card.onclick = (e) => {
                    // é˜²æ­¢é»æ“Šæ¨™ç±¤æˆ–æŒ‰éˆ•æ™‚è§¸ç™¼
                    if(e.target.tagName !== 'BUTTON') openModal(r); 
                };

                card.innerHTML = `
                    <div class="p-5 flex-1 flex flex-col cursor-pointer">
                        <div class="flex justify-between items-start mb-3">
                            <span class="bg-gray-800 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">${r.industry}</span>
                            <span class="text-xs text-gray-400 font-mono">${r.date}</span>
                        </div>
                        
                        <div class="mb-1">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                ${r.company} 
                                <span class="text-gray-400 text-xs font-normal bg-gray-100 px-1.5 rounded">${r.stockId}</span>
                            </h3>
                        </div>

                        ${r.subIndustry ? `<div class="text-xs text-green-600 mb-3 font-medium"><i class="fa-solid fa-tree mr-1"></i>${r.subIndustry}</div>` : '<div class="mb-3"></div>'}

                        <div class="flex items-center gap-2 mb-4 text-xs">
                            <span class="text-yellow-500">${r.importance}</span>
                            <span class="text-gray-400">|</span>
                            <span class="text-gray-500 font-medium truncate max-w-[80px]" title="${r.broker}">${r.broker}</span>
                            <span class="ml-auto px-2 py-0.5 rounded font-bold ${rateClass}">${r.rating || 'æœªè©•ç­‰'}</span>
                        </div>

                        <div class="mb-4 flex-grow relative">
                            <p class="text-gray-600 text-sm line-clamp-3 leading-relaxed">
                                ${r.summary || '<span class="text-gray-300 italic">æš«ç„¡æ‘˜è¦å…§å®¹...</span>'}
                            </p>
                            <div class="absolute bottom-0 left-0 w-full h-6 bg-gradient-to-t from-white to-transparent"></div>
                        </div>

                        <div class="flex flex-wrap gap-1 mt-auto">
                            ${tagsHTML}
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 px-5 py-3 border-t border-gray-100 flex justify-between items-center">
                        <div class="text-xs text-gray-500 flex flex-col">
                            <span class="scale-90 origin-left text-gray-400">TARGET PRICE</span>
                            <span class="font-bold text-gray-800 text-base">${r.targetPrice}</span>
                        </div>
                        <button onclick="openModal(${r.id})" class="text-white bg-gray-900 hover:bg-gray-700 rounded-lg px-3 py-1.5 text-xs font-medium transition flex items-center">
                            è©³ç´°åˆ†æ <i class="fa-solid fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Modal æ§åˆ¶
        function openModal(reportOrId) {
            let r = reportOrId;
            // å¦‚æœå‚³å…¥çš„æ˜¯ ID (å¾æŒ‰éˆ•è§¸ç™¼)ï¼Œå‰‡å¾é™£åˆ—æ‰¾
            if (typeof reportOrId === 'number') {
                r = allReports.find(item => item.id === reportOrId);
            }
            if(!r) return;

            // å¡«å…¥è³‡æ–™
            document.getElementById('modalTitle').textContent = r.company;
            document.getElementById('modalStockId').textContent = r.stockId;
            document.getElementById('modalDate').innerHTML = `<i class="fa-regular fa-clock mr-1"></i>${r.date}`;
            document.getElementById('modalBroker').textContent = r.broker + (r.analyst ? ` (${r.analyst})` : '');
            
            document.getElementById('modalRating').textContent = r.rating || '--';
            document.getElementById('modalTarget').textContent = r.targetPrice;
            document.getElementById('modalImportance').textContent = r.importance;

            // å…§å®¹å¡«å…¥ (æ”¯æ´ HTML æ›è¡Œ)
            const formatText = (text) => text ? text.replace(/\n/g, '<br>') : 'ç„¡è³‡æ–™';
            document.getElementById('modalSummary').innerHTML = formatText(r.summary);
            
            // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œéš±è—è©²å€å¡Š
            const toggleBlock = (id, content) => {
                const el = document.getElementById(id);
                const contentEl = el.querySelector('div, p');
                if (!content || content === 'ç„¡è³‡æ–™') {
                    el.classList.add('hidden');
                } else {
                    el.classList.remove('hidden');
                    contentEl.innerHTML = formatText(content);
                }
            };

            toggleBlock('blockHighlight', r.highlights);
            toggleBlock('blockRex', r.rexObs);

            // æ¨™ç±¤
            const tagsContainer = document.getElementById('modalTags');
            if(r.tags) {
                tagsContainer.innerHTML = r.tags.split('#').filter(t=>t.trim()).map(t => 
                    `<span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm border border-gray-200">#${t.trim()}</span>`
                ).join('');
            } else {
                tagsContainer.innerHTML = '';
            }

            // é¡¯ç¤º Modal
            const modal = document.getElementById('detailModal');
            modal.classList.remove('hidden');
            // ç°¡å–®å‹•ç•«
            const panel = modal.querySelector('.relative');
            panel.classList.add('modal-enter');
            setTimeout(() => {
                panel.classList.remove('modal-enter');
                panel.classList.add('modal-enter-active');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.add('hidden');
        }

    </script>
</body>
</html>
